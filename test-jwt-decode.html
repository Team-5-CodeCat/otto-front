<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JWT 토큰 디코딩 테스트</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .result {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .error {
        background: #ffebee;
        color: #c62828;
      }
      .success {
        background: #e8f5e8;
        color: #2e7d32;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔐 JWT 토큰 디코딩 테스트</h1>

      <div class="test-section">
        <h2>1. JWT 토큰 디코딩 함수 테스트</h2>
        <p>JWT 토큰을 입력하면 디코딩된 정보를 확인할 수 있습니다.</p>

        <textarea id="jwtInput" placeholder="JWT 토큰을 여기에 붙여넣으세요..." rows="3"></textarea>
        <br />
        <button onclick="decodeJWT()">토큰 디코딩</button>
        <button onclick="generateTestToken()">테스트 토큰 생성</button>

        <div id="decodeResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h2>2. 사용자 정보 추출 테스트</h2>
        <p>JWT 토큰에서 사용자 정보(userID, email)를 추출합니다.</p>

        <button onclick="extractUserInfo()">사용자 정보 추출</button>

        <div id="userInfoResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h2>3. 토큰 만료 확인 테스트</h2>
        <p>JWT 토큰의 만료 시간을 확인합니다.</p>

        <button onclick="checkTokenExpiry()">만료 시간 확인</button>

        <div id="expiryResult" class="result" style="display: none"></div>
      </div>
    </div>

    <script>
      // JWT 토큰 디코딩 함수 (프론트엔드와 동일)
      function decodeJWT(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split('')
              .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
              .join('')
          );
          return JSON.parse(jsonPayload);
        } catch (error) {
          console.error('JWT 디코딩 실패:', error);
          return null;
        }
      }

      // 사용자 정보 추출 함수
      function getUserFromToken(token) {
        const payload = decodeJWT(token);
        if (payload && payload.type === 'access') {
          return {
            userID: payload.sub,
            email: payload.email,
          };
        }
        return null;
      }

      // 토큰 만료 확인 함수
      function isTokenExpired(token) {
        const payload = decodeJWT(token);
        if (!payload || !payload.exp) {
          return true;
        }
        const currentTime = Date.now() / 1000;
        return payload.exp < currentTime;
      }

      // 토큰 디코딩 테스트
      function decodeJWT() {
        const token = document.getElementById('jwtInput').value.trim();
        const resultDiv = document.getElementById('decodeResult');

        if (!token) {
          resultDiv.innerHTML = '<div class="error">JWT 토큰을 입력해주세요.</div>';
          resultDiv.style.display = 'block';
          return;
        }

        const decoded = decodeJWT(token);
        if (decoded) {
          resultDiv.innerHTML = `
                    <div class="success">✅ JWT 디코딩 성공!</div>
                    <pre>${JSON.stringify(decoded, null, 2)}</pre>
                `;
        } else {
          resultDiv.innerHTML =
            '<div class="error">❌ JWT 디코딩 실패! 유효하지 않은 토큰입니다.</div>';
        }
        resultDiv.style.display = 'block';
      }

      // 사용자 정보 추출 테스트
      function extractUserInfo() {
        const token = document.getElementById('jwtInput').value.trim();
        const resultDiv = document.getElementById('userInfoResult');

        if (!token) {
          resultDiv.innerHTML = '<div class="error">JWT 토큰을 입력해주세요.</div>';
          resultDiv.style.display = 'block';
          return;
        }

        const userInfo = getUserFromToken(token);
        if (userInfo) {
          resultDiv.innerHTML = `
                    <div class="success">✅ 사용자 정보 추출 성공!</div>
                    <div><strong>User ID:</strong> ${userInfo.userID}</div>
                    <div><strong>Email:</strong> ${userInfo.email}</div>
                    <div><strong>Name:</strong> ${userInfo.email.split('@')[0] || '사용자'}</div>
                `;
        } else {
          resultDiv.innerHTML =
            '<div class="error">❌ 사용자 정보 추출 실패! Access Token이 아니거나 유효하지 않습니다.</div>';
        }
        resultDiv.style.display = 'block';
      }

      // 토큰 만료 확인 테스트
      function checkTokenExpiry() {
        const token = document.getElementById('jwtInput').value.trim();
        const resultDiv = document.getElementById('expiryResult');

        if (!token) {
          resultDiv.innerHTML = '<div class="error">JWT 토큰을 입력해주세요.</div>';
          resultDiv.style.display = 'block';
          return;
        }

        const payload = decodeJWT(token);
        if (!payload) {
          resultDiv.innerHTML = '<div class="error">❌ JWT 디코딩 실패!</div>';
          resultDiv.style.display = 'block';
          return;
        }

        const isExpired = isTokenExpired(token);
        const currentTime = new Date();
        const expiryTime = new Date(payload.exp * 1000);
        const timeLeft = expiryTime - currentTime;

        resultDiv.innerHTML = `
                <div class="${isExpired ? 'error' : 'success'}">
                    ${isExpired ? '❌ 토큰이 만료되었습니다!' : '✅ 토큰이 유효합니다!'}
                </div>
                <div><strong>발급 시간:</strong> ${new Date(payload.iat * 1000).toLocaleString()}</div>
                <div><strong>만료 시간:</strong> ${expiryTime.toLocaleString()}</div>
                <div><strong>현재 시간:</strong> ${currentTime.toLocaleString()}</div>
                <div><strong>남은 시간:</strong> ${isExpired ? '만료됨' : Math.floor(timeLeft / 1000 / 60) + '분 ' + Math.floor((timeLeft % 60000) / 1000) + '초'}</div>
            `;
        resultDiv.style.display = 'block';
      }

      // 테스트용 JWT 토큰 생성 (실제로는 백엔드에서 생성)
      function generateTestToken() {
        const testPayload = {
          sub: 'test-user-123',
          email: 'test@example.com',
          type: 'access',
          exp: Math.floor(Date.now() / 1000) + 15 * 60, // 15분 후 만료
          iat: Math.floor(Date.now() / 1000),
        };

        // 실제 JWT는 서명이 필요하지만, 테스트용으로 간단히 생성
        const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
        const payload = btoa(JSON.stringify(testPayload));
        const signature = 'test-signature'; // 실제로는 HMAC 서명이 필요

        const testToken = `${header}.${payload}.${signature}`;
        document.getElementById('jwtInput').value = testToken;

        document.getElementById('decodeResult').innerHTML = `
                <div class="success">✅ 테스트 토큰이 생성되었습니다!</div>
                <div><strong>주의:</strong> 이 토큰은 테스트용이며 실제 서명이 없어 백엔드에서 검증할 수 없습니다.</div>
            `;
        document.getElementById('decodeResult').style.display = 'block';
      }
    </script>
  </body>
</html>
